---
title: "NYC Taxi Trip Duration - Visualizations"
author: "Data Analysis"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    theme: flatly
    code_folding: hide
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE,
  fig.width = 10,
  fig.height = 6,
  fig.align = 'center'
)
```

# Data Loading & Preparation

```{r libraries}
library(data.table)
library(lubridate)
library(ggplot2)
library(gridExtra)
library(scales)
```

```{r load_data}
train <- fread("data/train.csv")

# Filtering
train <- train[
  passenger_count >= 1 & passenger_count <= 6 &
  trip_duration <= 36000
]

cat("Total trips after filtering:", nrow(train), "\n")
```

```{r feature_engineering}
# Time features
train[, hour := hour(pickup_datetime)]
train[, is_weekend := wday(pickup_datetime) %in% c(1, 7)]
train[, day_of_week := wday(pickup_datetime, label = TRUE)]

# Distance calculation
haversine <- function(lat1, lon1, lat2, lon2){
  R <- 6371
  dlat <- (lat2 - lat1) * pi / 180
  dlon <- (lon2 - lon1) * pi / 180
  a <- sin(dlat/2)^2 +
    cos(lat1*pi/180) * cos(lat2*pi/180) *
    sin(dlon/2)^2
  2 * R * asin(sqrt(a))
}

train[, distance_km := haversine(
  pickup_latitude, pickup_longitude,
  dropoff_latitude, dropoff_longitude
)]

# Speed
train[, speed_kmh := (distance_km / trip_duration) * 3600]
```

---

# Temporal Patterns

## Hourly Pattern

```{r hourly_pattern}
hourly_pattern <- train[, .(
  avg_duration = mean(trip_duration),
  median_duration = median(trip_duration),
  n = .N
), by = hour][order(hour)]

ggplot(hourly_pattern, aes(x = hour, y = avg_duration)) +
  geom_line(color = "#2E86AB", size = 1.2) +
  geom_point(color = "#A23B72", size = 3) +
  labs(
    title = "Average Trip Duration by Hour of Day",
    x = "Hour of Day",
    y = "Average Duration (seconds)"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    plot.title = element_text(face = "bold", hjust = 0.5),
    panel.grid.minor = element_blank()
  )
```

Key Insight: 평균 여행시간은 오후 2-3시에 가장 길고, 새벽 2-5시에 가장 짧습니다.

## Weekday vs Weekend

```{r weekday_weekend}
hourly_weekend <- train[, .(
  avg_duration = mean(trip_duration)
), by = .(hour, is_weekend)]

ggplot(hourly_weekend, aes(x = hour, y = avg_duration, 
                            color = is_weekend, group = is_weekend)) +
  geom_line(size = 1.2) +
  geom_point(size = 2) +
  scale_color_manual(
    values = c("FALSE" = "#2E86AB", "TRUE" = "#A23B72"),
    labels = c("Weekday", "Weekend"),
    name = ""
  ) +
  labs(
    title = "Trip Duration: Weekday vs Weekend",
    x = "Hour of Day",
    y = "Average Duration (seconds)"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    plot.title = element_text(face = "bold", hjust = 0.5),
    legend.position = "top"
  )
```

Key Insight: 평일이 전반적으로 주말보다 여행시간이 더 깁니다. 특히 출퇴근 시간대에 차이가 큽니다.

## Day of Week Pattern

```{r daily_pattern}
daily_pattern <- train[, .(
  avg_duration = mean(trip_duration),
  median_duration = median(trip_duration),
  n = .N
), by = day_of_week]

ggplot(daily_pattern, aes(x = day_of_week, y = avg_duration)) +
  geom_col(fill = "#2E86AB", alpha = 0.8) +
  geom_text(aes(label = round(avg_duration, 0)), vjust = -0.5, size = 3.5) +
  labs(
    title = "Average Trip Duration by Day of Week",
    x = "Day of Week",
    y = "Average Duration (seconds)"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    plot.title = element_text(face = "bold", hjust = 0.5)
  )
```

---

# Distance & Speed Analysis

## Distance vs Duration

```{r distance_duration, warning=FALSE}
sample_data <- train[sample(.N, 10000)]

ggplot(sample_data, aes(x = distance_km, y = trip_duration/60)) +
  geom_point(alpha = 0.3, color = "#2E86AB") +
  geom_smooth(method = "lm", color = "#A23B72", se = TRUE) +
  labs(
    title = "Distance vs Trip Duration",
    x = "Distance (km)",
    y = "Trip Duration (minutes)"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    plot.title = element_text(face = "bold", hjust = 0.5)
  ) +
  coord_cartesian(xlim = c(0, 20), ylim = c(0, 60))
```

```{r correlation}
cor_value <- cor(train$distance_km, train$trip_duration, use = "complete.obs")
cat("Correlation between distance and duration:", round(cor_value, 3), "\n")
```

## Speed Distribution

```{r speed_distribution}
speed_data <- train[speed_kmh > 0 & speed_kmh < 100]

ggplot(speed_data, aes(x = speed_kmh)) +
  geom_histogram(bins = 50, fill = "#2E86AB", alpha = 0.7, color = "white") +
  geom_vline(aes(xintercept = median(speed_kmh)), 
             color = "#A23B72", linetype = "dashed", size = 1) +
  labs(
    title = "Distribution of Average Speed",
    subtitle = paste("Median speed:", round(median(speed_data$speed_kmh), 1), "km/h"),
    x = "Speed (km/h)",
    y = "Count"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    plot.title = element_text(face = "bold", hjust = 0.5),
    plot.subtitle = element_text(hjust = 0.5, size = 10)
  )
```

---

# Passenger Analysis

## Passenger Count Distribution

```{r passenger_count}
passenger_summary <- train[, .(
  avg_duration = mean(trip_duration),
  n = .N
), by = passenger_count]

ggplot(passenger_summary, aes(x = factor(passenger_count), y = avg_duration)) +
  geom_col(fill = "#2E86AB", alpha = 0.8) +
  geom_text(aes(label = comma(n)), vjust = -0.5, size = 3) +
  labs(
    title = "Average Trip Duration by Passenger Count",
    subtitle = "Numbers above bars show trip counts",
    x = "Number of Passengers",
    y = "Average Duration (seconds)"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    plot.title = element_text(face = "bold", hjust = 0.5),
    plot.subtitle = element_text(hjust = 0.5, size = 10)
  )
```

```{r passenger_table}
passenger_summary[order(passenger_count)]
```

---

# Geographic Analysis

## Pickup Location Heatmap

```{r pickup_heatmap}
location_sample <- train[sample(.N, 20000)]

ggplot(location_sample, aes(x = pickup_longitude, y = pickup_latitude)) +
  geom_bin2d(bins = 50) +
  scale_fill_gradient(low = "#E8F4F8", high = "#2E86AB", name = "Count") +
  labs(
    title = "Pickup Location Density",
    x = "Longitude",
    y = "Latitude"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    plot.title = element_text(face = "bold", hjust = 0.5)
  ) +
  coord_cartesian(xlim = c(-74.05, -73.75), ylim = c(40.6, 40.9))
```

Key Insight: 맨해튼 중심부에서 픽업이 집중되어 있습니다.

---

# Summary Statistics

```{r summary_stats}
summary_table <- data.table(
  Metric = c(
    "Total Trips",
    "Average Duration (sec)",
    "Median Duration (sec)",
    "Average Distance (km)",
    "Median Speed (km/h)",
    "Weekday Trips",
    "Weekend Trips"
  ),
  Value = c(
    comma(nrow(train)),
    round(mean(train$trip_duration), 1),
    round(median(train$trip_duration), 1),
    round(mean(train$distance_km), 2),
    round(median(speed_data$speed_kmh), 1),
    comma(sum(!train$is_weekend)),
    comma(sum(train$is_weekend))
  )
)

summary_table
```